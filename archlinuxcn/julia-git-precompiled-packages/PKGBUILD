# Maintainer: Yichao Yu <yyc1992@gmail.com>

pkgbase=julia-git-precompiled-packages
_jlpackages=(
###=== JLPKG_JLNAME_LIST {{
  ASL_jll
  AbstractFFTs
  AbstractTrees
  Adapt
  AmplNLWriter
  ArnoldiMethod
  ArrayInterface
  ArrayInterfaceCore
  AxisAlgorithms
  AxisArrays
  BenchmarkTools
  BitFlags
  BitTwiddlingConvenienceFunctions
  Blosc
  Blosc_jll
  BufferedStreams
  Bzip2_jll
  CEnum
  CPUSummary
  CSV
  Cairo_jll
  Calculus
  CatIndices
  CategoricalArrays
  Cbc
  Cbc_jll
  Cgl_jll
  ChainRulesCore
  ChangesOfVariables
  CloseOpenIntervals
  Clp
  Clp_jll
  Clustering
  CodeTracking
  CodecBase
  CodecBzip2
  CodecLz4
  CodecXz
  CodecZlib
  CodecZstd
  CoinUtils_jll
  ColorSchemes
  ColorTypes
  ColorVectorSpace
  Colors
  Combinatorics
  CommonSolve
  CommonSubexpressions
  Compat
  ComputationalResources
  ConcurrentUtilities
  Conda
  ConstructionBase
  Contour
  CoordinateTransformations
  CpuId
  Crayons
  Cthulhu
  Cubature
  Cubature_jll
  CustomUnitRanges
  DataAPI
  DataFrames
  DataStructures
  DataValueInterfaces
  DensityInterface
  Dierckx
  Dierckx_jll
  DiffResults
  DiffRules
  Distances
  Distributions
  DocStringExtensions
  DualNumbers
  EpollShim_jll
  ExceptionUnwrapping
  Expat_jll
  ExprTools
  EzXML
  FFMPEG
  FFMPEG_jll
  FFTViews
  FFTW
  FFTW_jll
  FileIO
  FilePathsBase
  FillArrays
  FiniteDiff
  FixedPointNumbers
  FlameGraphs
  FoldingTrees
  Fontconfig_jll
  Formatting
  ForwardDiff
  FreeType2_jll
  FreqTables
  FriBidi_jll
  FunctionWrappers
  GLFW_jll
  GLPK
  GLPK_jll
  GPUArrays
  GPUArraysCore
  GR
  GR_jll
  GSL
  GSL_jll
  Gettext_jll
  Ghostscript_jll
  GitHub
  GitHubActions
  Glib_jll
  Graphics
  Graphite2_jll
  Graphs
  Grisu
  H5Zbitshuffle
  H5Zblosc
  H5Zbzip2
  H5Zlz4
  H5Zzstd
  HCubature
  HDF5
  HDF5_jll
  HTTP
  HarfBuzz_jll
  HistogramThresholding
  HostCPUFeatures
  Hwloc_jll
  HypergeometricFunctions
  IJulia
  IfElse
  ImageAxes
  ImageBase
  ImageBinarization
  ImageContrastAdjustment
  ImageCore
  ImageCorners
  ImageDistances
  ImageFiltering
  ImageIO
  ImageMagick
  ImageMagick_jll
  ImageMetadata
  ImageMorphology
  ImageQualityIndexes
  ImageSegmentation
  ImageShow
  ImageTransformations
  Images
  Imath_jll
  IndirectArrays
  Inflate
  IniFile
  InlineStrings
  IntegralArrays
  IntelOpenMP_jll
  Interpolations
  IntervalSets
  InverseFunctions
  InvertedIndices
  Ipopt
  Ipopt_jll
  IrrationalConstants
  IterTools
  IteratorInterfaceExtensions
  JET
  JLD2
  JLFzf
  JSON
  JpegTurbo
  JpegTurbo_jll
  JuMP
  JuliaInterpreter
  JuliaSyntax
  Juniper
  LAME_jll
  LERC_jll
  LLVM
  LLVMExtra_jll
  LLVMOpenMP_jll
  LZO_jll
  LaTeXStrings
  Latexify
  LayoutPointers
  LazyModules
  LeftChildRightSiblingTrees
  Libffi_jll
  Libgcrypt_jll
  Libglvnd_jll
  Libgpg_error_jll
  Libiconv_jll
  Libmount_jll
  Libtiff_jll
  Libuuid_jll
  LineSearches
  LittleCMS_jll
  LogExpFunctions
  LoggingExtras
  LoopVectorization
  LoweredCodeUtils
  LsqFit
  Lz4_jll
  MAT
  METIS_jll
  MKL_jll
  MPI
  MPICH_jll
  MPIPreferences
  MPItrampoline_jll
  MUMPS_seq_jll
  MacroTools
  MakieCore
  ManualMemory
  MappedArrays
  MathOptInterface
  MbedTLS
  Measures
  MetaGraphs
  MicrosoftMPI_jll
  Missings
  Mocking
  MosaicViews
  Mustache
  MutableArithmetics
  NLSolversBase
  NLopt
  NLopt_jll
  NLsolve
  NaNMath
  NamedArrays
  NearestNeighbors
  Netpbm
  Observables
  OffsetArrays
  Ogg_jll
  OpenBLAS32_jll
  OpenCL
  OpenCL_jll
  OpenEXR
  OpenEXR_jll
  OpenJpeg_jll
  OpenMPI_jll
  OpenSSL
  OpenSSL_jll
  OpenSpecFun_jll
  Optim
  OptimBase
  Opus_jll
  OrderedCollections
  Osi_jll
  PDMats
  PNGFiles
  PaddedViews
  Parameters
  Parsers
  Pipe
  Pixman_jll
  PkgVersion
  PlotThemes
  PlotUtils
  Plots
  PolyesterWeave
  Polynomials
  PooledArrays
  PositiveFactorizations
  PrecompileTools
  Preferences
  PrettyTables
  ProgressMeter
  PyCall
  PyPlot
  QOI
  Qt6Base_jll
  QuadGK
  Quaternions
  RangeArrays
  Ratios
  RealDot
  RecipesBase
  RecipesPipeline
  Reexport
  RegionTrees
  RelocatableFolders
  Requires
  Revise
  Rmath
  Rmath_jll
  Roots
  Rotations
  SIMD
  SIMDTypes
  SLEEFPirates
  SPRAL_jll
  Scratch
  SentinelArrays
  Setfield
  Showoff
  SimpleBufferStream
  SimpleTraits
  SimpleWeightedGraphs
  Sixel
  SnoopCompile
  SnoopCompileCore
  SnoopPrecompile
  SodiumSeal
  SoftGlobalScope
  SortingAlgorithms
  SpecialFunctions
  StackViews
  Static
  StaticArrayInterface
  StaticArrays
  StaticArraysCore
  StatsAPI
  StatsBase
  StatsFuns
  StringEncodings
  StringManipulation
  StructArrays
  TZJData
  TableTraits
  Tables
  TensorCore
  ThreadingUtilities
  TiffImages
  TiledIteration
  TimeZones
  TranscodingStreams
  TypedSyntax
  URIs
  UnPack
  UnicodeFun
  Unitful
  UnitfulLatexify
  Unzip
  VectorizationBase
  VersionParsing
  Vulkan_Loader_jll
  Wayland_jll
  Wayland_protocols_jll
  WeakRefStrings
  WidthLimitedIO
  WoodburyMatrices
  WorkerUtilities
  XML2_jll
  XSLT_jll
  XZ_jll
  Xorg_libICE_jll
  Xorg_libSM_jll
  Xorg_libX11_jll
  Xorg_libXau_jll
  Xorg_libXcursor_jll
  Xorg_libXdmcp_jll
  Xorg_libXext_jll
  Xorg_libXfixes_jll
  Xorg_libXi_jll
  Xorg_libXinerama_jll
  Xorg_libXrandr_jll
  Xorg_libXrender_jll
  Xorg_libpthread_stubs_jll
  Xorg_libxcb_jll
  Xorg_libxkbfile_jll
  Xorg_xcb_util_cursor_jll
  Xorg_xcb_util_image_jll
  Xorg_xcb_util_jll
  Xorg_xcb_util_keysyms_jll
  Xorg_xcb_util_renderutil_jll
  Xorg_xcb_util_wm_jll
  Xorg_xkbcomp_jll
  Xorg_xkeyboard_config_jll
  Xorg_xtrans_jll
  YAML
  ZMQ
  ZeroMQ_jll
  Zstd_jll
  ZygoteRules
  bitshuffle_jll
  eudev_jll
  fzf_jll
  gperf_jll
  libaec_jll
  libaom_jll
  libass_jll
  libevdev_jll
  libfdk_aac_jll
  libinput_jll
  libpng_jll
  libsixel_jll
  libsodium_jll
  libvorbis_jll
  mtdev_jll
  x264_jll
  x265_jll
  xkbcommon_jll
###=== }} JLPKG_JLNAME_LIST
)
pkgname=()
pkgver=20231004.061223
pkgrel=1
pkgdesc="Precompiled packages for julia-git"
arch=('i686' 'x86_64' 'armv7h' 'aarch64')
url="http://julialang.org"
license=('GPL')
depends=(julia-git)
makedepends=(git julia-git-package-env julia-pkg-scripts glfw-x11
             julia-git-packages-meta)
options=('debug' '!strip')
source=()
sha512sums=()

pkgver() {
  date -u +%Y%m%d.%H%M%S
}

_package-jlpackage() {
  # Don't depend on the exact julia version to make it easier to install
  # a new julia version that without updating all the precompiled packages
  # In such a case the precompiled binaries won't be used but the packages
  # should still work.
  # depends+=("julia-git=$(pacman -Q julia-git | sed -e 's/^.* \([^ ]*\)$/\1/')")

  jlpkg=$1
  srcpkg="julia-git-${jlpkg,,}-src"

  depends+=("$srcpkg")
  conflicts+=("julia-git-${jlpkg,,}-git") # Temporary
  replaces+=("julia-git-${jlpkg,,}-git") # Temporary

  ver_short=$(julia --startup-file=no \
                    -e 'print(VERSION.major, ".", VERSION.minor)')
  compile_dir="/usr/share/julia/compiled/v$ver_short"
  stdlib_dir="/usr/share/julia/stdlib/v$ver_short"
  mkdir -p "${pkgdir}/${compile_dir}"

  for deps in $(julia "/usr/lib/julia/julia-list-deps.jl" "$stdlib_dir/$jlpkg"); do
    depends+=("julia-git-${deps,,}")
  done

  _jlpkgs=($jlpkg)

  for p in "$stdlib_dir/$jlpkg/Project.toml" "$stdlib_dir/$jlpkg/JuliaProject.toml"; do
    if [[ -f "$p" ]]; then
      _jlpkgs=("${_jlpkgs[@]}"
               $(julia -e 'd = get(Base.parsed_toml(ARGS[1]), "extensions", nothing); if d !== nothing; println(join(keys(d), " ")) end' "$p"))
      break
    fi
  done

  for _jlpkg in "${_jlpkgs[@]}"; do
    if [[ -d "${compile_dir}/${_jlpkg}" ]]; then
      # This is a bit cheating as we are simply copying the version
      # from the package hook
      cp -a "${compile_dir}/${_jlpkg}" "${pkgdir}/${compile_dir}"
      touch "${pkgdir}/${compile_dir}/${_jlpkg}/.archpkg"
    fi
  done
}

for jlpkg in "${_jlpackages[@]}"; do
  _pkg="julia-git-${jlpkg,,}"
  pkgname=("${pkgname[@]}" "${_pkg}")
  eval "package_${_pkg}() { _package-jlpackage ${jlpkg}; }"
done
